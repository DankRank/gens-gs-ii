PROJECT(gens-gs-ii)
cmake_minimum_required(VERSION 2.6)

list (APPEND CMAKE_MODULE_PATH "${gens-gs-ii_SOURCE_DIR}/CMake")

# Git version information.
ADD_CUSTOM_TARGET(git_version ALL
	${gens-gs-ii_SOURCE_DIR}/git_version.sh -s "${gens-gs-ii_SOURCE_DIR}" -o "${gens-gs-ii_BINARY_DIR}/git_version.h"
	VERBATIM
)

# Hack to remove -rdynamic from CFLAGS and CXXFLAGS
# See http://public.kitware.com/pipermail/cmake/2006-July/010404.html
IF(CMAKE_SYSTEM_NAME STREQUAL "Linux")
	SET(CMAKE_SHARED_LIBRARY_LINK_C_FLAGS)
	SET(CMAKE_SHARED_LIBRARY_LINK_CXX_FLAGS)
ENDIF()

# Don't embed rpaths in the executables.
SET(CMAKE_SKIP_RPATH ON)

# If no build type is set, default to "debug".
IF(CMAKE_BUILD_TYPE MATCHES ^$)
	SET(CMAKE_BUILD_TYPE "debug")
ENDIF()

# Don't bother with verbose makefiles for now.
# TODO: Make it an option?
#IF (CMAKE_BUILD_TYPE MATCHES ^debug$)
#	SET(CMAKE_VERBOSE_MAKEFILE ON)
#ENDIF()

# Check what flag is needed for C99 support.
INCLUDE(CheckC99CompilerFlag)
CHECK_C99_COMPILER_FLAG(GENS_C99_CFLAG)

# Test for common CFLAGS and CXXFLAGS.
INCLUDE(CheckCCompilerFlag)
INCLUDE(CheckCXXCompilerFlag)
SET(GENS_CFLAGS_COMMON "")
SET(GENS_CXXFLAGS_COMMON "")
FOREACH(FLAG_TEST "-Wall" "-Wextra")
	CHECK_C_COMPILER_FLAG("${FLAG_TEST}" CFLAG_${FLAG_TEST}_RESULT)
	IF(CFLAG_${FLAG_TEST}_RESULT)
		SET(CFLAGS_COMMON "${GENS_CFLAGS_COMMON} ${FLAG_TEST}")
	ENDIF(CFLAG_${FLAG_TEST}_RESULT)
	UNSET(CFLAG_${FLAG_TEST}_RESULT)
	
	CHECK_CXX_COMPILER_FLAG("${FLAG_TEST}" CXXFLAG_${FLAG_TEST}_RESULT)
	IF(CXXFLAG_${FLAG_TEST}_RESULT)
		SET(CXXFLAGS_COMMON "${GENS_CXXFLAGS_COMMON} ${FLAG_TEST}")
	ENDIF(CXXFLAG_${FLAG_TEST}_RESULT)
	UNSET(CXXFLAG_${FLAG_TEST}_RESULT)
ENDFOREACH()

# Platform-specific CFLAGS/CXXFLAGS.
IF(WIN32)
	SET(CFLAGS_PLATFORM "-gstabs -fshort_wchar")
	SET(CXXFLAGS_PLATFORM "-gstabs -fshort_wchar")
ELSEIF(UNIX)
	SET(CFLAGS_PLATFORM "-ggdb")
	SET(CXXFLAGS_PLATFORM "-ggdb")
ENDIF()

# Set CFLAGS/CXXFLAGS based on build type.
SET(CMAKE_C_FLAGS_DEBUG		"-O0 ${C99_CFLAG} ${CFLAGS_COMMON} ${CFLAGS_PLATFORM}")
SET(CMAKE_CXX_FLAGS_DEBUG	"-O0 ${CXXFLAGS_COMMON} ${CXXFLAGS_PLATFORM}")
SET(CMAKE_C_FLAGS_RELEASE	"-O2 -march=i586 -mtune=i686 ${C99_CFLAG} ${CFLAGS_COMMON} ${CFLAGS_PLATFORM}")
SET(CMAKE_CXX_FLAGS_RELEASE	"-O2 -march=i586 -mtune=i686 ${CXXFLAGS_COMMON} ${CXXFLAGS_PLATFORM}")

# Project subdirectories
SUBDIRS(src)
